<script type="module">
const bookSelect=document.getElementById('bookSelect');
const chapterSelect=document.getElementById('chapterSelect');
const bibleContentDiv=document.getElementById('bibleContent');
const aiOutputDiv=document.getElementById('aiOutput');
const explainButton=document.getElementById('explainButton');
const loading=document.getElementById('loadingIndicator');
const prevBtn=document.getElementById('prevChapter');
const nextBtn=document.getElementById('nextChapter');
const loadError=document.getElementById('loadError');
let bibleData={};

// ğŸš€ ç›´æ¥è¼‰å…¥ JSON
async function loadBible(){
  try{
    const res=await fetch('bible.json');
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    bibleData=await res.json();

    for(const b in bibleData){
      let o=document.createElement('option');
      o.value=b;o.textContent=b;
      bookSelect.appendChild(o);
    }
  }catch(e){
    loadError.textContent="âŒ è–ç¶“è¼‰å…¥å¤±æ•—ï¼š"+e.message+"ï¼Œè«‹ç¢ºèª bible.json å­˜åœ¨æ–¼åŒä¸€è³‡æ–™å¤¾ã€‚";
    loadError.classList.remove('hidden');
  }
}
loadBible();

// é¸æ›¸å·
bookSelect.addEventListener('change',()=>{
  const b=bookSelect.value;
  chapterSelect.innerHTML='<option>é¸æ“‡ç« ç¯€</option>';
  if(!b){chapterSelect.disabled=true;return;}
  chapterSelect.disabled=false;
  Object.keys(bibleData[b]).forEach(ch=>{
    let o=document.createElement('option');
    o.value=ch;o.textContent=`ç¬¬${ch}ç« `;
    chapterSelect.appendChild(o);
  });
});

// é¡¯ç¤ºç« ç¯€
chapterSelect.addEventListener('change',()=>showChapter());
function showChapter(){
  const b=bookSelect.value;const ch=chapterSelect.value;
  if(!b||!ch){bibleContentDiv.textContent="è«‹é¸æ“‡æ›¸å·å’Œç« ç¯€";return;}
  bibleContentDiv.innerHTML=bibleData[b][ch].map(v=>`<p>${v}</p>`).join('');
  explainButton.disabled=false;
  prevBtn.disabled=!bibleData[b][parseInt(ch)-1];
  nextBtn.disabled=!bibleData[b][parseInt(ch)+1];
}
prevBtn.onclick=()=>{chapterSelect.value=parseInt(chapterSelect.value)-1;showChapter();}
nextBtn.onclick=()=>{chapterSelect.value=parseInt(chapterSelect.value)+1;showChapter();}

// AI è§£é‡‹ï¼ˆä¿æŒåŸé‚è¼¯ï¼‰
explainButton.onclick=async()=>{
  const b=bookSelect.value;const ch=chapterSelect.value;
  const passage=bibleContentDiv.innerText;if(!b||!ch)return;
  loading.classList.remove('hidden');aiOutputDiv.textContent='';
  try{
    const prompt=`è«‹ç”¨ä¸­æ–‡ï¼ˆç¹é«”ï¼‰è§£é‡‹é€™æ®µè–ç¶“ç« ç¯€ï¼š${b} ç¬¬${ch}ç« \n${passage}`;
    const payload={model:"gpt-4o-mini",messages:[{role:"user",content:prompt}]};
    const res=await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{"Authorization":"Bearer YOUR_API_KEY","Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    const data=await res.json();
    aiOutputDiv.innerHTML=data.choices[0].message.content.replace(/\n/g,'<br>');
  }catch(e){
    aiOutputDiv.textContent="AI è§£é‡‹å¤±æ•—ï¼š"+e;
  }
  loading.classList.add('hidden');
};
</script>
